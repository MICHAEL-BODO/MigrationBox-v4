service: migrationbox-discovery
frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${env:REGION, 'us-east-1'}
  memorySize: 512
  timeout: 300
  environment:
    STAGE: ${self:provider.stage}
    PROVIDER: ${env:PROVIDER, 'aws'}
    WORKLOADS_TABLE: migrationbox-workloads-${self:provider.stage}
    EVENT_BUS: migrationbox-events-${self:provider.stage}

functions:
  startDiscovery:
    handler: handler.startDiscovery
    description: Initiate a new workload discovery scan
    events:
      - http:
          path: /v1/discoveries
          method: post
          cors: true

  getDiscovery:
    handler: handler.getDiscovery
    description: Get discovery scan status and results
    events:
      - http:
          path: /v1/discoveries/{id}
          method: get
          cors: true

  listWorkloads:
    handler: handler.listWorkloads
    description: List discovered workloads
    events:
      - http:
          path: /v1/discoveries/{id}/workloads
          method: get
          cors: true

  getDependencies:
    handler: handler.getDependencies
    description: Get dependency graph for a discovery
    events:
      - http:
          path: /v1/discoveries/{id}/dependencies
          method: get
          cors: true

  processAwsDiscovery:
    handler: handler.processAwsDiscovery
    description: Process AWS resource discovery (async)
    timeout: 900
    memorySize: 1024
    events:
      - sqs:
          arn: !GetAtt DiscoveryQueue.Arn

resources:
  Resources:
    DiscoveryQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: migrationbox-discovery-${self:provider.stage}
        VisibilityTimeout: 960
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt DiscoveryDLQ.Arn
          maxReceiveCount: 3

    DiscoveryDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: migrationbox-discovery-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600
